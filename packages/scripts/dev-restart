#!/usr/bin/env bash
set -euo pipefail

# dev-restart: Restart the agent or nvim in a development session
# Usage: dev-restart <session-name> [--agent opencode|claude] [--nvim]

SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
DEFAULT_DEV_DIR="$HOME/.dev-sessions"
DEV_DIR="${DEV_DIR:-$DEFAULT_DEV_DIR}"
SESSIONS_DIR="$DEV_DIR/sessions"

# opencode server port range
OPENCODE_PORT_MIN=4100
OPENCODE_PORT_MAX=4199

# nvim server port range
NVIM_PORT_MIN=6100
NVIM_PORT_MAX=6199

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}→${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warn() { echo -e "${YELLOW}!${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1" >&2; }

usage() {
    cat << EOF
Usage: dev-restart <session-name> [options]

Restart the agent or nvim in a development session.

Options:
  --agent <name>    Change agent (opencode|claude)
  --nvim            Restart nvim instead of agent
  --all             Restart both agent and nvim
  --help            Show this help

Examples:
  dev-restart my-session
  dev-restart my-session --agent claude
  dev-restart my-session --nvim
  dev-restart my-session --all
EOF
    exit 0
}

# Generate a deterministic port for a session name (hash-based)
get_session_port() {
    local session_name=$1
    local min=$2
    local max=$3
    local range=$((max - min + 1))
    
    local hash=$(echo -n "$session_name" | md5sum | cut -c1-8)
    local hash_dec=$((16#$hash))
    local port=$((min + (hash_dec % range)))
    
    echo "$port"
}

# Find next available port in range
find_available_port() {
    local min=$1
    local max=$2
    for port in $(seq $min $max); do
        if ! ss -tlnp | grep -q ":$port "; then
            echo "$port"
            return
        fi
    done
    echo ""
}

# Parse arguments
SESSION_NAME=""
NEW_AGENT=""
RESTART_AGENT=true
RESTART_NVIM=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --agent)
            NEW_AGENT="$2"
            shift 2
            ;;
        --nvim)
            RESTART_AGENT=false
            RESTART_NVIM=true
            shift
            ;;
        --all)
            RESTART_AGENT=true
            RESTART_NVIM=true
            shift
            ;;
        --help|-h)
            usage
            ;;
        -*)
            log_error "Unknown option: $1"
            exit 1
            ;;
        *)
            if [[ -z "$SESSION_NAME" ]]; then
                SESSION_NAME="$1"
            fi
            shift
            ;;
    esac
done

if [[ -z "$SESSION_NAME" ]]; then
    log_error "Session name required"
    usage
fi

# Check session exists
SESSION_DIR="$SESSIONS_DIR/$SESSION_NAME"
META_FILE="$SESSION_DIR/meta.json"

if [[ ! -f "$META_FILE" ]]; then
    log_error "Session not found: $SESSION_NAME"
    exit 1
fi

# Read current config
CURRENT_AGENT=$(jq -r '.agent' "$META_FILE")
AGENT="${NEW_AGENT:-$CURRENT_AGENT}"
WORKTREE=$(jq -r '.worktree' "$META_FILE")

# Check worktree exists
if [[ ! -d "$WORKTREE" ]]; then
    log_error "Worktree directory not found: $WORKTREE"
    log_info "The session worktree may have been deleted. Delete the session metadata with dev-delete $SESSION_NAME"
    exit 1
fi

# Get/update opencode port if needed
if [[ "$AGENT" == "opencode" ]]; then
    OPENCODE_PORT=$(jq -r '.opencode_port // empty' "$META_FILE")
    
    if [[ -z "$OPENCODE_PORT" || "$OPENCODE_PORT" == "null" ]]; then
        OPENCODE_PORT=$(get_session_port "$SESSION_NAME" $OPENCODE_PORT_MIN $OPENCODE_PORT_MAX)
        
        if ss -tlnp | grep -q ":$OPENCODE_PORT "; then
            log_warn "Preferred port $OPENCODE_PORT in use, finding alternative..."
            OPENCODE_PORT=$(find_available_port $OPENCODE_PORT_MIN $OPENCODE_PORT_MAX)
        fi
        
        if [[ -n "$OPENCODE_PORT" ]]; then
            jq --argjson port "$OPENCODE_PORT" '.opencode_port = $port' "$META_FILE" > "$META_FILE.tmp" \
                && mv "$META_FILE.tmp" "$META_FILE"
        fi
    fi
fi

# Get/update nvim port if needed
NVIM_PORT=$(jq -r '.nvim_port // empty' "$META_FILE")

if [[ -z "$NVIM_PORT" || "$NVIM_PORT" == "null" ]]; then
    NVIM_PORT=$(get_session_port "${SESSION_NAME}-nvim" $NVIM_PORT_MIN $NVIM_PORT_MAX)
    
    if ss -tlnp | grep -q ":$NVIM_PORT "; then
        log_warn "Preferred nvim port $NVIM_PORT in use, finding alternative..."
        NVIM_PORT=$(find_available_port $NVIM_PORT_MIN $NVIM_PORT_MAX)
    fi
    
    if [[ -n "$NVIM_PORT" ]]; then
        jq --argjson port "$NVIM_PORT" '.nvim_port = $port' "$META_FILE" > "$META_FILE.tmp" \
            && mv "$META_FILE.tmp" "$META_FILE"
    fi
fi

# Recreate the tmux session with new layout
log_info "Recreating tmux session with new layout..."

# Kill existing session
tmux kill-session -t "$SESSION_NAME" >/dev/null 2>&1 || true

# Enable mouse support
tmux set-option -t "$SESSION_NAME" mouse on

# Create servers window
tmux new-session -d -s "$SESSION_NAME" -n "servers" -c "$WORKTREE" bash -c 'eval "$(mise activate bash 2>/dev/null || true)" && exec bash'

# Start opencode server in background if restarting agent and opencode
if $RESTART_AGENT && [[ "$AGENT" == "opencode" ]] && [[ -n "$OPENCODE_PORT" ]]; then
    tmux send-keys -t "$SESSION_NAME:servers" "opencode serve --port $OPENCODE_PORT --hostname 0.0.0.0 &" Enter
    log_info "OpenCode server running on port $OPENCODE_PORT"
fi

# Start nvim server in background if restarting nvim
if $RESTART_NVIM && [[ -n "$NVIM_PORT" ]]; then
    tmux send-keys -t "$SESSION_NAME:servers" "nvim --headless --listen 0.0.0.0:$NVIM_PORT &" Enter
    log_info "Neovim server running on port $NVIM_PORT"
fi

# Create pane layout: vertical split, then left horizontally split
tmux split-window -t "$SESSION_NAME:servers" -h  # vertical split: left .0, right .1
tmux select-pane -t "$SESSION_NAME:servers.0"
tmux split-window -t "$SESSION_NAME:servers" -v  # horizontal split left: top .0, bottom .2 (since .1 is right)

# Select servers window
tmux select-window -t "$SESSION_NAME:servers"

# Update agent in meta if changed
if [[ -n "$NEW_AGENT" && "$NEW_AGENT" != "$CURRENT_AGENT" ]]; then
    jq --arg agent "$NEW_AGENT" '.agent = $agent' "$META_FILE" > "$META_FILE.tmp" \
        && mv "$META_FILE.tmp" "$META_FILE"
    log_info "Agent changed: $CURRENT_AGENT → $NEW_AGENT"
fi

log_success "Session restarted successfully"

# Show web interfaces
echo ""
echo "Web interfaces:"
if [[ -n "$OPENCODE_PORT" ]]; then
echo "  OpenCode: http://localhost:$OPENCODE_PORT"
fi
if [[ -n "$NVIM_PORT" ]]; then
echo "  Neovim: nvim --remote-ui --server localhost:$NVIM_PORT"
fi

# Update last_activity
jq --arg time "$(date -Iseconds)" '.last_activity = $time' "$META_FILE" > "$META_FILE.tmp" \
    && mv "$META_FILE.tmp" "$META_FILE"
