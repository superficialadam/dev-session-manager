#!/usr/bin/env bash
set -euo pipefail

# dev-restart: Restart services and agent in a development session
# Usage: dev-restart <session-name> [--agent opencode|claude] [--services]

SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
DEFAULT_DEV_DIR="$HOME/.dev-sessions"
DEV_DIR="${DEV_DIR:-$DEFAULT_DEV_DIR}"
SESSIONS_DIR="$DEV_DIR/sessions"
REPOS_FILE="$DEV_DIR/repos.json"

source "$SCRIPT_DIR/lib/ports.sh"

OPENCODE_PORT_MIN=4100
OPENCODE_PORT_MAX=4199

NVIM_PORT_MIN=6100
NVIM_PORT_MAX=6199

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}→${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warn() { echo -e "${YELLOW}!${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1" >&2; }

usage() {
    cat << EOF
Usage: dev-restart <session-name> [options]

Restart services and agent in a development session.
Does NOT run install scripts (use dev-new for fresh setup).

Options:
  --agent <name>    Change agent (opencode|claude)
  --agent-only      Restart agent only (not services)
  --services        Restart services only (not agent)
  --all             Restart agent and services (default)
  --help            Show this help

Examples:
  dev-restart my-session
  dev-restart my-session --agent claude
  dev-restart my-session --services
EOF
    exit 0
}

get_session_port() {
    local session_name=$1
    local min=$2
    local max=$3
    local range=$((max - min + 1))
    
    local hash=$(echo -n "$session_name" | md5sum | cut -c1-8)
    local hash_dec=$((16#$hash))
    local port=$((min + (hash_dec % range)))
    
    echo "$port"
}

SESSION_NAME=""
NEW_AGENT=""
RESTART_AGENT=true
RESTART_SERVICES=true
AGENT_ONLY=false
DEV_RESTART_BG=${DEV_RESTART_BG:-}

while [[ $# -gt 0 ]]; do
    case $1 in
        --agent)
            NEW_AGENT="$2"
            shift 2
            ;;
        --agent-only)
            AGENT_ONLY=true
            RESTART_AGENT=true
            RESTART_SERVICES=false
            shift
            ;;
        --services)
            RESTART_AGENT=false
            RESTART_SERVICES=true
            shift
            ;;
        --all)
            RESTART_AGENT=true
            RESTART_SERVICES=true
            shift
            ;;
        --help|-h)
            usage
            ;;
        -*)
            log_error "Unknown option: $1"
            exit 1
            ;;
        *)
            if [[ -z "$SESSION_NAME" ]]; then
                SESSION_NAME="$1"
            fi
            shift
            ;;
    esac
done

if [[ -z "$SESSION_NAME" ]]; then
    log_error "Session name required"
    usage
fi

if [[ -n "${TMUX:-}" && -z "$DEV_RESTART_BG" ]]; then
    CURRENT_SESSION=$(tmux display-message -p '#S')
    if [[ "$CURRENT_SESSION" == "$SESSION_NAME" ]]; then
        log_warn "dev-restart is running inside $SESSION_NAME; restarting from background"
        RESTART_ARGS=()
        if [[ -n "$NEW_AGENT" ]]; then
            RESTART_ARGS+=(--agent "$NEW_AGENT")
        fi
        if $AGENT_ONLY; then
            RESTART_ARGS+=(--agent-only)
        elif $RESTART_SERVICES && ! $RESTART_AGENT; then
            RESTART_ARGS+=(--services)
        fi
        RESTART_ARGS+=("$SESSION_NAME")
        RESTART_CMD=(DEV_RESTART_BG=1 "$SCRIPT_PATH" "${RESTART_ARGS[@]}")
        tmux run-shell -b "$(printf '%q ' "${RESTART_CMD[@]}")"
        tmux detach-client
        exit 0
    fi
fi

# Check session exists
SESSION_DIR="$SESSIONS_DIR/$SESSION_NAME"
META_FILE="$SESSION_DIR/meta.json"

if [[ ! -f "$META_FILE" ]]; then
    log_error "Session not found: $SESSION_NAME"
    exit 1
fi

# Read current config
CURRENT_AGENT=$(jq -r '.agent' "$META_FILE")
AGENT="${NEW_AGENT:-$CURRENT_AGENT}"
WORKTREE=$(jq -r '.worktree' "$META_FILE")

# Check worktree exists
if [[ ! -d "$WORKTREE" ]]; then
    log_error "Worktree directory not found: $WORKTREE"
    log_info "The session worktree may have been deleted. Delete the session metadata with dev-delete $SESSION_NAME"
    exit 1
fi

# Get/update opencode port if needed
if [[ "$AGENT" == "opencode" ]]; then
    OPENCODE_PORT=$(jq -r '.opencode_port // empty' "$META_FILE")
    
    if [[ -z "$OPENCODE_PORT" || "$OPENCODE_PORT" == "null" ]]; then
        OPENCODE_PORT=$(get_session_port "$SESSION_NAME" $OPENCODE_PORT_MIN $OPENCODE_PORT_MAX)
        
        if ss -tlnp | grep -q ":$OPENCODE_PORT "; then
            log_warn "Preferred port $OPENCODE_PORT in use, finding alternative..."
            OPENCODE_PORT=$(find_available_port $OPENCODE_PORT_MIN $OPENCODE_PORT_MAX)
        fi
        
        if [[ -n "$OPENCODE_PORT" ]]; then
            jq --argjson port "$OPENCODE_PORT" '.opencode_port = $port' "$META_FILE" > "$META_FILE.tmp" \
                && mv "$META_FILE.tmp" "$META_FILE"
        fi
    fi
fi

# Get/update nvim port if needed
NVIM_PORT=$(jq -r '.nvim_port // empty' "$META_FILE")

if [[ -z "$NVIM_PORT" || "$NVIM_PORT" == "null" ]]; then
    NVIM_PORT=$(get_session_port "${SESSION_NAME}-nvim" $NVIM_PORT_MIN $NVIM_PORT_MAX)
    
    if ss -tlnp | grep -q ":$NVIM_PORT "; then
        log_warn "Preferred nvim port $NVIM_PORT in use, finding alternative..."
        NVIM_PORT=$(find_available_port $NVIM_PORT_MIN $NVIM_PORT_MAX)
    fi
    
    if [[ -n "$NVIM_PORT" ]]; then
        jq --argjson port "$NVIM_PORT" '.nvim_port = $port' "$META_FILE" > "$META_FILE.tmp" \
            && mv "$META_FILE.tmp" "$META_FILE"
    fi
fi

# Recreate the tmux session with new layout
log_info "Recreating tmux session with new layout..."
log_info "Session name: $SESSION_NAME"
log_info "Worktree: $WORKTREE"

# Kill existing session if it exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    log_info "Killing existing session..."
    tmux kill-session -t "$SESSION_NAME" >/dev/null 2>&1 || true
    for _ in {1..10}; do
        if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
            sleep 0.2
        else
            break
        fi
    done
fi

log_info "Creating servers window..."
SESSION_CREATED=false
for _ in {1..3}; do
    if tmux new-session -d -s "$SESSION_NAME" -n "servers" -c "$WORKTREE" bash -c 'eval "$(mise activate bash 2>/dev/null || true)" && exec bash'; then
        SESSION_CREATED=true
        break
    fi
    log_warn "Failed to create tmux session, retrying..."
    sleep 0.3
done

if ! $SESSION_CREATED; then
    log_error "Failed to create tmux session: $SESSION_NAME"
    exit 1
fi

# Enable mouse mode for web/mobile terminal access
tmux set-option -t "$SESSION_NAME" mouse on
tmux set-option -t "$SESSION_NAME" set-clipboard on
tmux bind-key -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel
tmux bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel

# Always start opencode server when recreating session
if [[ "$AGENT" == "opencode" ]] && [[ -n "$OPENCODE_PORT" ]]; then
    log_info "Starting OpenCode server..."
    tmux send-keys -t "$SESSION_NAME:servers" "cd $WORKTREE && opencode web --port $OPENCODE_PORT --hostname 0.0.0.0 &" Enter
    log_info "OpenCode server running on port $OPENCODE_PORT"
fi

log_info "Creating pane layout..."
tmux split-window -t "$SESSION_NAME:servers" -h -c "$WORKTREE"
tmux select-pane -t "$SESSION_NAME:servers.0"
tmux split-window -t "$SESSION_NAME:servers" -v -c "$WORKTREE"
tmux select-pane -t "$SESSION_NAME:servers.0"
tmux split-window -t "$SESSION_NAME:servers" -v -c "$WORKTREE"

LEFT_PANE_ORDER=()
while read -r pane_index pane_left pane_top; do
    if [[ "$pane_left" == "0" ]]; then
        LEFT_PANE_ORDER+=("$pane_index:$pane_top")
    fi
done < <(tmux list-panes -t "$SESSION_NAME:servers" -F "#{pane_index} #{pane_left} #{pane_top}")

IFS=$'\n' sorted_left=($(sort -t: -k2,2n <<<"${LEFT_PANE_ORDER[*]}"))
unset IFS
LEFT_PANES=()
for entry in "${sorted_left[@]}"; do
    LEFT_PANES+=("${entry%%:*}")
done

RIGHT_PANE=""
RIGHT_LEFT=-1
while read -r pane_index pane_left; do
    if (( pane_left > RIGHT_LEFT )); then
        RIGHT_LEFT=$pane_left
        RIGHT_PANE=$pane_index
    fi
done < <(tmux list-panes -t "$SESSION_NAME:servers" -F "#{pane_index} #{pane_left}")

if [[ -n "$RIGHT_PANE" && -n "$OPENCODE_PORT" ]]; then
    tmux send-keys -t "$SESSION_NAME:servers.$RIGHT_PANE" "opencode attach http://localhost:$OPENCODE_PORT" Enter
fi

tmux new-window -t "$SESSION_NAME" -n "nvim" -c "$WORKTREE"
tmux send-keys -t "$SESSION_NAME:nvim" "nvim" Enter

SERVICES_FILE="$SESSION_DIR/services.json"
if $RESTART_SERVICES && [[ -f "$SERVICES_FILE" ]]; then
    log_info "Restarting services from services.json..."
    
    PANE_ORDER=("${LEFT_PANES[@]}")
    if [[ ${#PANE_ORDER[@]} -lt 3 ]]; then
        PANE_ORDER=(0 1 2)
    fi
    SERVICE_IDX=0
    
    jq -c '.services[]' "$SERVICES_FILE" | while read -r service; do
        if [[ $SERVICE_IDX -ge 3 ]]; then
            log_warn "More than 3 services, only restarting first 3"
            break
        fi
        SERVICE_NAME=$(echo "$service" | jq -r '.name')
        SERVICE_CMD=$(echo "$service" | jq -r '.cmd')
        SERVICE_CWD=$(echo "$service" | jq -r '.cwd // ""')
        SERVICE_PORT=$(echo "$service" | jq -r '.port // 0')
        
        PANE_IN_WINDOW=$((SERVICE_IDX % 3))
        PANE=${PANE_ORDER[$PANE_IN_WINDOW]}
        
        PANE_TARGET="$SESSION_NAME:servers.$PANE"
        
        FULL_CWD="$WORKTREE"
        [[ -n "$SERVICE_CWD" ]] && FULL_CWD="$WORKTREE/$SERVICE_CWD"
        
        FULL_CMD="cd $FULL_CWD && "
        if [[ "$SERVICE_PORT" -gt 0 ]]; then
            PORT_ENV=$(echo "$service" | jq -r '.port_env // "PORT"')
            FULL_CMD+="$PORT_ENV=$SERVICE_PORT "
            log_info "Service $SERVICE_NAME: port $SERVICE_PORT"
        fi
        FULL_CMD+="$SERVICE_CMD"
        
        tmux send-keys -t "$PANE_TARGET" "$FULL_CMD" Enter
        SERVICE_IDX=$((SERVICE_IDX + 1))
    done
    
    log_success "Services restarted"
fi

log_info "Selecting servers window..."
tmux select-window -t "$SESSION_NAME:servers"

# Update agent in meta if changed
if [[ -n "$NEW_AGENT" && "$NEW_AGENT" != "$CURRENT_AGENT" ]]; then
    jq --arg agent "$NEW_AGENT" '.agent = $agent' "$META_FILE" > "$META_FILE.tmp" \
        && mv "$META_FILE.tmp" "$META_FILE"
    log_info "Agent changed: $CURRENT_AGENT → $NEW_AGENT"
fi

log_success "Session restarted successfully"

echo ""
echo "Web interfaces:"
if [[ -n "$OPENCODE_PORT" ]]; then
echo "  OpenCode: http://localhost:$OPENCODE_PORT"
fi

if [[ -f "$SERVICES_FILE" ]]; then
    echo ""
    echo "Services:"
    jq -r '.services[] | select(.port > 0) | "  \(.name): http://localhost:\(.port)"' "$SERVICES_FILE" 2>/dev/null || true
fi

# Update last_activity
jq --arg time "$(date -Iseconds)" '.last_activity = $time' "$META_FILE" > "$META_FILE.tmp" \
    && mv "$META_FILE.tmp" "$META_FILE"
