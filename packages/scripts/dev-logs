#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
DEFAULT_DEV_DIR="$HOME/.dev-sessions"
DEV_DIR="${DEV_DIR:-$DEFAULT_DEV_DIR}"
SESSIONS_DIR="$DEV_DIR/sessions"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}→${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1" >&2; }

usage() {
    cat << EOF
Usage: dev-logs <session-name> [service-name]

Tail logs from a service's tmux pane.

Arguments:
  session-name    Name of the dev session
  service-name    Name of service (optional, lists services if omitted)

Examples:
  dev-logs my-session                # list available services
  dev-logs my-session dashboard      # tail dashboard logs
EOF
    exit 0
}

if [[ $# -lt 1 ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
    usage
fi

SESSION_NAME="$1"
SERVICE_NAME="${2:-}"

SESSION_DIR="$SESSIONS_DIR/$SESSION_NAME"
SERVICES_FILE="$SESSION_DIR/services.json"

if [[ ! -f "$SERVICES_FILE" ]]; then
    log_error "No services found for session: $SESSION_NAME"
    log_info "Services file not found: $SERVICES_FILE"
    exit 1
fi

if [[ -z "$SERVICE_NAME" ]]; then
    echo "Available services for $SESSION_NAME:"
    jq -r '.services[] | "  \(.name) (port \(.port), pane \(.pane))"' "$SERVICES_FILE"
    exit 0
fi

SERVICE=$(jq -r --arg name "$SERVICE_NAME" '.services[] | select(.name == $name)' "$SERVICES_FILE")

if [[ -z "$SERVICE" ]]; then
    log_error "Service not found: $SERVICE_NAME"
    echo ""
    echo "Available services:"
    jq -r '.services[].name' "$SERVICES_FILE" | sed 's/^/  /'
    exit 1
fi

PANE=$(echo "$SERVICE" | jq -r '.pane')

if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    log_error "Tmux session not running: $SESSION_NAME"
    exit 1
fi

log_info "Tailing logs for $SERVICE_NAME (pane: $PANE)"
log_info "Press Ctrl+C to stop"
echo ""

while true; do
    tmux capture-pane -t "$PANE" -p -S -100 2>/dev/null | tail -50
    sleep 1
    clear
done
