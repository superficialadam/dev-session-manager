#!/usr/bin/env bash
set -euo pipefail

# dev-send: Send a prompt to the agent in a session
# Usage: dev-send <session> "prompt" | --file prompt.md

SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
DEFAULT_DEV_DIR="$HOME/dev"
DEV_DIR="${DEV_DIR:-$DEFAULT_DEV_DIR}"
SESSIONS_DIR="$DEV_DIR/sessions"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}→${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warn() { echo -e "${YELLOW}!${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1" >&2; }

usage() {
    cat << EOF
Usage: dev-send <session> <prompt>
       dev-send <session> --file <file>
       echo "prompt" | dev-send <session> --stdin

Send a prompt to the AI agent in a session.

Options:
  --file <file>    Read prompt from file
  --stdin          Read prompt from stdin
  --no-log         Don't log to history
  --help           Show this help

Examples:
  dev-send feature-auth "Add login form validation"
  dev-send feature-auth --file prompt.md
  echo "Fix the bug" | dev-send feature-auth --stdin
EOF
    exit 0
}

get_agent_state() {
    local session="$1"
    
    local content
    content=$(tmux capture-pane -t "$session:agent" -p -S -20 2>/dev/null || echo "")
    
    if [[ -z "$content" ]]; then
        echo "unknown"
        return
    fi
    
    local last_line
    last_line=$(echo "$content" | grep -v '^$' | tail -1)
    
    if [[ "$last_line" =~ [❯\>][[:space:]]*$ ]]; then
        echo "idle"
    else
        echo "working"
    fi
}

SESSION_NAME=""
PROMPT=""
FROM_FILE=""
FROM_STDIN=false
NO_LOG=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --file)
            FROM_FILE="$2"
            shift 2
            ;;
        --stdin)
            FROM_STDIN=true
            shift
            ;;
        --no-log)
            NO_LOG=true
            shift
            ;;
        --help|-h)
            usage
            ;;
        -*)
            log_error "Unknown option: $1"
            exit 1
            ;;
        *)
            if [[ -z "$SESSION_NAME" ]]; then
                SESSION_NAME="$1"
            else
                PROMPT="$1"
            fi
            shift
            ;;
    esac
done

if [[ -z "$SESSION_NAME" ]]; then
    log_error "Session name required"
    usage
fi

# Get prompt from source
if [[ -n "$FROM_FILE" ]]; then
    if [[ ! -f "$FROM_FILE" ]]; then
        log_error "File not found: $FROM_FILE"
        exit 1
    fi
    PROMPT=$(cat "$FROM_FILE")
elif $FROM_STDIN; then
    PROMPT=$(cat)
fi

if [[ -z "$PROMPT" ]]; then
    log_error "Prompt required"
    usage
fi

SESSION_DIR="$SESSIONS_DIR/$SESSION_NAME"

# Check session exists
if [[ ! -d "$SESSION_DIR" ]]; then
    log_error "Session not found: $SESSION_NAME"
    exit 1
fi

# Check tmux session
if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    log_error "Tmux session not running: $SESSION_NAME"
    exit 1
fi

# Check agent state
AGENT_STATE=$(get_agent_state "$SESSION_NAME")
if [[ "$AGENT_STATE" != "idle" ]]; then
    log_warn "Agent appears to be $AGENT_STATE, sending anyway..."
fi

# Log to history
if ! $NO_LOG; then
    HISTORY_FILE="$SESSION_DIR/history.jsonl"
    echo "{\"ts\": \"$(date -Iseconds)\", \"type\": \"prompt\", \"content\": $(echo "$PROMPT" | jq -Rs .)}" >> "$HISTORY_FILE"
fi

# Update last_activity in meta.json
META_FILE="$SESSION_DIR/meta.json"
if [[ -f "$META_FILE" ]]; then
    jq --arg ts "$(date -Iseconds)" '.last_activity = $ts | .status = "working"' "$META_FILE" > "$META_FILE.tmp" && mv "$META_FILE.tmp" "$META_FILE"
fi

# Send to tmux
log_info "Sending prompt to $SESSION_NAME..."

# For multi-line prompts, we need to be careful
# Using send-keys with literal flag for each line
while IFS= read -r line || [[ -n "$line" ]]; do
    tmux send-keys -t "$SESSION_NAME:agent" -l "$line"
    tmux send-keys -t "$SESSION_NAME:agent" Enter
done <<< "$PROMPT"

log_success "Prompt sent"
log_info "Watch with: dev-attach $SESSION_NAME --window agent"
