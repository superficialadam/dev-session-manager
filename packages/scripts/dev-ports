#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
DEFAULT_DEV_DIR="$HOME/.dev-sessions"
DEV_DIR="${DEV_DIR:-$DEFAULT_DEV_DIR}"
SESSIONS_DIR="$DEV_DIR/sessions"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_error() { echo -e "${RED}âœ—${NC} $1" >&2; }

usage() {
    cat << EOF
Usage: dev-ports [session-name]

Show allocated ports for a session or all sessions.

Arguments:
  session-name    Name of the dev session (optional, shows all if omitted)

Examples:
  dev-ports                  # show all sessions' ports
  dev-ports my-session       # show ports for my-session
EOF
    exit 0
}

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    usage
fi

SESSION_NAME="${1:-}"

show_session_ports() {
    local session_name=$1
    local session_dir="$SESSIONS_DIR/$session_name"
    local meta_file="$session_dir/meta.json"
    local services_file="$session_dir/services.json"
    
    if [[ ! -f "$meta_file" ]]; then
        return
    fi
    
    echo -e "${BLUE}$session_name${NC}"
    
    TTYD_PORT=$(jq -r '.ttyd_port // empty' "$meta_file" 2>/dev/null)
    OPENCODE_PORT=$(jq -r '.opencode_port // empty' "$meta_file" 2>/dev/null)
    NVIM_PORT=$(jq -r '.nvim_port // empty' "$meta_file" 2>/dev/null)
    
    [[ -n "$TTYD_PORT" && "$TTYD_PORT" != "null" ]] && echo "  ttyd:     http://localhost:$TTYD_PORT"
    [[ -n "$OPENCODE_PORT" && "$OPENCODE_PORT" != "null" ]] && echo "  opencode: http://localhost:$OPENCODE_PORT"
    [[ -n "$NVIM_PORT" && "$NVIM_PORT" != "null" ]] && echo "  nvim:     localhost:$NVIM_PORT"
    
    if [[ -f "$services_file" ]]; then
        jq -r '.services[] | select(.port > 0) | "  \(.name): http://localhost:\(.port)"' "$services_file" 2>/dev/null || true
    fi
    
    echo ""
}

if [[ -n "$SESSION_NAME" ]]; then
    SESSION_DIR="$SESSIONS_DIR/$SESSION_NAME"
    if [[ ! -d "$SESSION_DIR" ]]; then
        log_error "Session not found: $SESSION_NAME"
        exit 1
    fi
    show_session_ports "$SESSION_NAME"
else
    if [[ ! -d "$SESSIONS_DIR" ]]; then
        echo "No sessions found"
        exit 0
    fi
    
    for session_dir in "$SESSIONS_DIR"/*/; do
        [[ -d "$session_dir" ]] || continue
        session_name=$(basename "$session_dir")
        show_session_ports "$session_name"
    done
fi
