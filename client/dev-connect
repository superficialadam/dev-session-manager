#!/usr/bin/env bash
set -euo pipefail

# dev-connect: Connect to a development session on hetzner
# Usage: dev-connect [session-name]

SERVER="100.119.128.1"
API_URL="http://${SERVER}:3333/api"

RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

log_error() { echo -e "${RED}✗${NC} $1" >&2; }
log_info() { echo -e "${CYAN}→${NC} $1"; }

fetch_sessions() {
    curl -s "${API_URL}/sessions" | jq '.sessions'
}

pick_session() {
    log_info "Fetching sessions from $SERVER..." >/dev/tty

    local sessions_json
    sessions_json=$(fetch_sessions)

    if [[ -z "$sessions_json" || "$sessions_json" == "[]" || "$sessions_json" == "null" ]]; then
        log_error "No sessions found on server"
        exit 1
    fi

    local count
    count=$(echo "$sessions_json" | jq 'length')

    echo "" >/dev/tty
    echo "Available sessions:" >/dev/tty
    echo "" >/dev/tty

    local i=1
    echo "$sessions_json" | jq -r '.[] | "\(.name)\t\(.repo)\t\(.branch)\t\(.agent_state)"' | \
    while IFS=$'\t' read -r name repo branch state; do
        local state_icon
        case "$state" in
            idle)    state_icon="${GREEN}●${NC}" ;;
            working) state_icon="${CYAN}◐${NC}" ;;
            error)   state_icon="${RED}●${NC}" ;;
            *)       state_icon="${DIM}○${NC}" ;;
        esac
        printf "  %b %2d) ${CYAN}%-25s${NC} ${DIM}%s → %s${NC}\n" "$state_icon" "$i" "$name" "$repo" "$branch" >/dev/tty
        ((i++))
    done

    echo "" >/dev/tty
    printf "Select session (1-%s): " "$count" >/dev/tty
    read -r selection </dev/tty

    if [[ ! "$selection" =~ ^[0-9]+$ ]] || [[ "$selection" -lt 1 ]] || [[ "$selection" -gt "$count" ]]; then
        log_error "Invalid selection"
        exit 1
    fi

    echo "$sessions_json" | jq ".[$((selection-1))]"
}

get_session() {
    local name="$1"
    local sessions_json
    sessions_json=$(fetch_sessions)

    local session
    session=$(echo "$sessions_json" | jq -r --arg name "$name" '.[] | select(.name == $name)')

    if [[ -z "$session" ]]; then
        log_error "Session not found: $name"
        exit 1
    fi

    echo "$session"
}

connect_session() {
    local session_json="$1"

    local name
    name=$(echo "$session_json" | jq -r '.name')

    log_info "Connecting to session: $name"
    exec mosh hetzner -- /home/adam/.local/bin/dev-attach "$name"
}

main() {
    local session_json

    if [[ $# -eq 0 ]]; then
        session_json=$(pick_session)
    else
        session_json=$(get_session "$1")
    fi

    connect_session "$session_json"
}

main "$@"
